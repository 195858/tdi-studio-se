<%@ jet 
imports="
    org.talend.core.model.process.INode 
    org.talend.core.model.process.ElementParameterParser 
    org.talend.designer.codegen.config.CodeGeneratorArgument
    org.talend.core.model.process.IConnection
    org.talend.core.model.utils.NodeUtil
" 
%>
<%
    CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
    INode node = (INode)codeGenArgument.getArgument();

    String cid = node.getUniqueName();

    String connection = ElementParameterParser.getValue(node, "__CONNECTION__");

    boolean close = ("true").equals(ElementParameterParser.getValue(node,"__CLOSE__"));

    String mdmTransaction = "mdmTransaction_" + connection;
	
	String conn = "";
%>
	Boolean useClientTransactionId_<%=cid%> = false;
	<%conn = "TMDMService_" + connection;%>
	
	  org.talend.mdm.webservice.TMDMService_ServiceLocator tmdmService_<%=cid %> = new org.talend.mdm.webservice.TMDMService_ServiceLocator();
	  org.talend.mdm.webservice.TMDMService_PortType conn_<%=cid%> = (org.talend.mdm.webservice.TMDMService_PortType)globalMap.get("<%=conn%>");
  	  String globalMdmURL_<%=cid%> = (String) globalMap.get("mdmURL_<%=connection%>");
  	  String globalMdmUsername_<%=cid%> = (String) globalMap.get("mdmUsername_<%=connection%>");
 	  String globalMdmPassword_<%=cid%> = (String) globalMap.get("mdmPassword_<%=connection%>");
 	  if(null != globalMdmURL_<%=cid%> && null != globalMdmUsername_<%=cid%> && null != globalMdmPassword_<%=cid%>){
  		  tmdmService_<%=cid %>.setTMDMPortEndpointAddress(globalMdmURL_<%=cid%>);
  		  conn_<%=cid%> = tmdmService_<%=cid %>.getTMDMPort();    
		  ((org.talend.mdm.webservice.TMDMServiceSoapBindingStub)conn_<%=cid%>).setUsername(globalMdmUsername_<%=cid%>);
		  ((org.talend.mdm.webservice.TMDMServiceSoapBindingStub)conn_<%=cid%>).setPassword(globalMdmPassword_<%=cid%>);
  	  }
	
    if(conn_<%=cid%> != null){
       useClientTransactionId_<%=cid%> = (Boolean)globalMap.get("useClientTransactionId_<%=connection%>");
       if(null != useClientTransactionId_<%=cid%> && useClientTransactionId_<%=cid%>){
		  com.talend.mdm.transaction.client.MDMTransaction mdmTransaction_<%=cid%> = null;
		  java.util.Map threadRunResultMap = threadLocal.get();
		  if(threadRunResultMap.get("mdmTransaction")!=null){
			 mdmTransaction_<%=cid%> = (com.talend.mdm.transaction.client.MDMTransaction)threadRunResultMap.get("mdmTransaction");
		  }
		  if(mdmTransaction_<%=cid%> != null) {
			 mdmTransaction_<%=cid%>.commit();
			 threadRunResultMap.remove("mdmTransaction");
			 threadLocal.set(threadRunResultMap);
		  }
	   }else{
	 	  com.talend.mdm.transaction.client.MDMTransaction mdmTransaction_<%=cid%> = (com.talend.mdm.transaction.client.MDMTransaction)globalMap.get("<%=mdmTransaction%>");
		  if(mdmTransaction_<%=cid%> != null) {
			 mdmTransaction_<%=cid%>.commit();
		  }
       }
  	<%if(close){%>
        conn_<%=cid%>.logout(new org.talend.mdm.webservice.WSLogout());
    <%}%>
  }