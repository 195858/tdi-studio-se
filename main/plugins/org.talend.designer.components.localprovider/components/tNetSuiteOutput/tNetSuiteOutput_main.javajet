<%@ jet 
	imports="
    	org.talend.core.model.process.INode 
    	org.talend.core.model.process.ElementParameterParser 
		org.talend.core.model.metadata.IMetadataTable 
		org.talend.core.model.metadata.IMetadataColumn
		org.talend.designer.codegen.config.CodeGeneratorArgument
		org.talend.core.model.process.IConnection
		org.talend.core.model.process.IConnectionCategory
		org.talend.core.model.metadata.types.JavaTypesManager
		org.talend.core.model.metadata.types.JavaType
		java.util.List
		java.util.ArrayList
	"
%>

<%
    CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
    INode node = (INode)codeGenArgument.getArgument();
    boolean useProxy = ElementParameterParser.getValue(node,"__USE_PROXY__").equals("true");
    boolean dieonerror = ElementParameterParser.getValue(node,"__CEASE_FOR_ERROR__").equals("true");
    String proxyHost = ElementParameterParser.getValue(node,"__PROXY_HOST__");
    String proxyPort = ElementParameterParser.getValue(node,"__PROXY_PORT__");
    String proxyUsername = ElementParameterParser.getValue(node,"__PROXY_USERNAME__");
    String proxyPassword = ElementParameterParser.getValue(node,"__PROXY_PASSWORD__");
    String action = ElementParameterParser.getValue(node, "__ACTION__");
    String modulename = ElementParameterParser.getValue(node, "__MODULENAME__");
%>

<%
	if(useProxy){
%>

        java.util.Properties props = System.getProperties();
        props.put("socksProxyHost",<%=proxyHost %>);  
        props.put("socksProxyPort",<%=proxyPort %>);
        props.put("java.net.socks.username", <%=proxyUsername %>);
        props.put("java.net.socks.password", <%=proxyPassword %>); 
    
<%
	}
%>

<%
    String entitytype=modulename;
    boolean isCustom = false;
    if (modulename.endsWith("CustomRecord")){
    	isCustom=true;
    	entitytype = ElementParameterParser.getValue(node, "__CUSTOMRECORDID__").trim();
    }
    
    boolean ceaseForError = ElementParameterParser.getValue(node, "__CEASE_FOR_ERROR__").equals("true");
    
    List<IMetadataTable> metadatas = node.getMetadataList();
    if ((metadatas!=null)&&(metadatas.size()>0)) {//1
        IMetadataTable metadata = metadatas.get(0);
        if (metadata!=null) {//2
            String cid = node.getUniqueName();
        	List< ? extends IConnection> conns = node.getIncomingConnections();
        	IConnection conn = conns.get(0);
    		if (conn.getLineStyle().hasConnectionCategory(IConnectionCategory.DATA)) {//4
%>
                
                //TODO expand from only InternalId to selecting ExternalId and more??
                //TODO handle upsert when record not found
                //TODO detect Custom Recs and fields with a startsWith("cust")
                
                <%=modulename%> record_<%=cid%> = new <%=modulename%>();
                // String id_<%=cid%> = <%=conn.getName() %>.InternalId;
                boolean useExternal_<%=cid%> = false;
                com.netsuite.webservices.platform.messages_2014_2.WriteResponse response_<%=cid%> = null;
                
                /*String id_<%=cid%> = <%=conn.getName() %>.InternalId;
                if (id_<%=cid%>==null) {
                  id_<%=cid%> = <%=conn.getName() %>.ExternalId;
                  useExternal_<%=cid%>=true;
                }
                
                if (useExternal_<%=cid%>) {
                	record_<%=cid%>.setExternalId(id_<%=cid%>);
                } else {
                	record_<%=cid%>.setInternalId(id_<%=cid%>);
                }*/
                
<%
                if ("insert".equals(action) || "update".equals(action) || "upsert".equals(action)) { //************
                	List<IMetadataColumn> columns = metadata.getListColumns();
                    int sizeColumns = columns.size();
                    for (int i = 0; i < sizeColumns; i++) { //5  			
                    	IMetadataColumn column = columns.get(i);
                    	
                    	//make sure to filter the schema "Id", when updating (but not when upserting)
                  		if("Id".equals(column.getLabel()) && !("upsert".equals(action))) {
                  			continue;
                  		}
                  		
                		JavaType javaType = JavaTypesManager.getJavaTypeFromId(column.getTalendType());
%>

        	    		if (<%=conn.getName() %>.<%=column.getLabel() %> == null) {
        					com.netsuite.webservices.platform.core_2014_2.NullField fl = record_<%=cid%>.getNullFieldList();
        					if (fl==null) {
        						record_<%=cid%>.setNullFieldList(new com.netsuite.webservices.platform.core_2014_2.NullField());
        					}
        					
        					String label = "<%=column.getLabel()%>";
        					String field = label.substring(0, 1).toLowerCase() + label.substring(1);
        					nsMgr_<%=cid%>.setNullFieldValue(record_<%=cid%>.getNullFieldList(), field);
        	    		} else {

<%
        				String pattern = column.getPattern() == null || column.getPattern().trim().length() == 0 ? null : column.getPattern();
    					//TODO For now we will assume initial lower case is a custom field and upper case has getter
    					char first=column.getLabel().charAt(0);
    					if(first<'a' || first>'z'){
        					if (javaType == JavaTypesManager.DATE && pattern != null && pattern.trim().length() != 0) {//Date
%>

        						java.util.Calendar cal_<%=cid%> = java.util.Calendar.getInstance();
        						cal_<%=cid%>.setTime(<%=conn.getName() %>.<%=column.getLabel()%>);
        						record_<%=cid%>.set<%=column.getLabel()%>(cal_<%=cid%>);

<%
							} else if (javaType == JavaTypesManager.BYTE_ARRAY) {//byte[]
%>

								record_<%=cid%>.set<%=column.getLabel()%>(java.nio.charset.Charset.defaultCharset().decode(java.nio.ByteBuffer.wrap(<%=conn.getName() %>.<%=column.getLabel() %>)).toString());

<%
							} else if (javaType == JavaTypesManager.OBJECT) {//byte[]
%>

								nsMgr_<%=cid%>.invokeSetter(record_<%=cid%>,"<%=column.getLabel()%>",<%=conn.getName() %>.<%=column.getLabel()%>);

<%
							} else {//others
%>

								record_<%=cid%>.set<%=column.getLabel()%>(<%=conn.getName() %>.<%=column.getLabel() %>);

<%
							}
						} else {
%>
    						com.netsuite.webservices.platform.core_2014_2.CustomFieldList fl = record_<%=cid%>.getCustomFieldList();
    						if (fl==null) {
    							record_<%=cid%>.setCustomFieldList(new com.netsuite.webservices.platform.core_2014_2.CustomFieldList());
    						}
    						nsMgr_<%=cid%>.setCustomFieldValue(record_<%=cid%>.getCustomFieldList(), "<%=javaType.getNullableClass().getSimpleName()%>", "<%=column.getLabel()%>", <%=conn.getName() %>.<%=column.getLabel() %>);

<%
						}
%>
			
        	    		}//if !=null
				
<%
                    }//5
				}//upsert, insert, update	
%> 

        	try {
 				
<%
                if ("insert".equals(action)) {
%>

            		response_<%=cid%> = nsMgr_<%=cid%>.insert("<%=entitytype %>", record_<%=cid%>);
            		
            		if (!response_<%=cid%>.getStatus().isIsSuccess()) {
						throw new java.rmi.RemoteException(nsMgr_<%=cid%>.getStatusDetails(response_<%=cid%>.getStatus()));
					}/* else {
						System.out.println(nsMgr_<%=cid%>.getStatusDetails(response_<%=cid%>.getStatus()));
					}*/
            		
                    // globalMap.put("<%=cid%>_CURRENT_INTERNALID", <%=conn.getName() %>.InternalId);

<%
				} else if ("update".equals(action)) {
%>

					response_<%=cid%> = nsMgr_<%=cid%>.update("<%=entitytype %>", record_<%=cid%>);
					
					if (!response_<%=cid%>.getStatus().isIsSuccess()) {
						throw new java.rmi.RemoteException(nsMgr_<%=cid%>.getStatusDetails(response_<%=cid%>.getStatus()));
					}

<%
				} else if ("upsert".equals(action)) {
%> 

                    <%=conn.getName() %>.InternalId=nsMgr_<%=cid%>.upsert("<%=entitytype %>", record_<%=cid%>);		
                    globalMap.put("<%=cid%>_CURRENT_INTERNALID", <%=conn.getName() %>.InternalId);
		
<%
				} else if ("delete".equals(action)) {
%>

					nsMgr_<%=cid%>.delete("<%=entitytype %>", useExternal_<%=cid%>, <%=conn.getName() %>.InternalId);		

<%
				}
%>  

        	} catch (Exception e) {

<%
				if(dieonerror){
%>

					throw (e);

<%
				} else {
%>

					System.err.print(e.getMessage());

<%
				}
%>
			}
			
			nb_line_<%=cid %>++; 
			///////////////////////    			

<%
    		}//4
    		
        	String rejectConnName = null;
        	List< ? extends IConnection> outConns = node.getOutgoingConnections("REJECT");
    		for (IConnection outConn : outConns) {//3
    			if (outConn.getLineStyle().hasConnectionCategory(IConnectionCategory.DATA)) {//4
    				rejectConnName = outConn.getName();
    				List<IMetadataColumn> rejectColumnList = null;
					IMetadataTable metadataTable = node.getMetadataFromConnector("REJECT");
					if(metadataTable != null) {
					    rejectColumnList = metadataTable.getListColumns();	    
					}
					
 					if ("insert".equals(action)) {
%>

 						<%=rejectConnName %> = new <%=rejectConnName %>Struct();

<%
	                    List<IMetadataColumn> columnList = metadata.getListColumns();
	                    for(IMetadataColumn column2 : columnList) {
%>

	                     	<%=rejectConnName%>.<%=column2.getLabel()%> = <%=conn.getName()%>.<%=column2.getLabel()%>;

<%
	                     }
%>

 						<%=rejectConnName%>.isSuccess = response_<%=cid%>.getStatus().isIsSuccess();
 						
 						if(response_<%=cid%>.getStatus().isIsSuccess()){
 							<%=rejectConnName%>.errorMessage = null;
 							if(<%=isCustom%>) {
<%
 								boolean containsField = false;
 								for(java.lang.reflect.Field field : rejectConnName.getClass().getDeclaredFields()){
									if(field.getName().equals("InternalId")){
										containsField = true;
										break;
									}
								}
						        
 								if(containsField) {
 %>
     								<%=rejectConnName%>.InternalId = ((com.netsuite.webservices.platform.core_2014_2.CustomRecordRef)response_<%=cid%>.getBaseRef()).getInternalId();
<%
 								}
%>
 							} else {
<%
 								if(containsField) {
%>
     								<%=rejectConnName%>.InternalId = ((com.netsuite.webservices.platform.core_2014_2.RecordRef)response_<%=cid%>.getBaseRef()).getInternalId();
<%
 								}
%>
 							}
 						} else {
 							<%=rejectConnName%>.errorMessage = new java.util.ArrayList<String>();
 							for(int i=0;i<response_<%=cid%>.getStatus().getStatusDetail().length;i++) {
 								<%=rejectConnName%>.errorMessage.add(response_<%=cid%>.getStatus().getStatusDetail(i).getMessage());
 							}
 						}
    				
<%
    				} else if ("update".equals(action)) {
%>
    					<%=rejectConnName %> = new <%=rejectConnName %>Struct();

<%
	                    List<IMetadataColumn> columnList = metadata.getListColumns();
	                    for(IMetadataColumn column2 : columnList) {
%>

	                     	<%=rejectConnName%>.<%=column2.getLabel()%> = <%=conn.getName()%>.<%=column2.getLabel()%>;

<%
	                    }
%>

 						<%=rejectConnName%>.isSuccess = response_<%=cid%>.getStatus().isIsSuccess();
 						
 						if(response_<%=cid%>.getStatus().isIsSuccess()){
 							<%=rejectConnName%>.errorMessage = null;
 							if(<%=isCustom%>) {
 								<%=rejectConnName%>.InternalId = ((com.netsuite.webservices.platform.core_2014_2.CustomRecordRef)response_<%=cid%>.getBaseRef()).getInternalId();
 							} else {
 								<%=rejectConnName%>.InternalId = ((com.netsuite.webservices.platform.core_2014_2.RecordRef)response_<%=cid%>.getBaseRef()).getInternalId();
 							}
 						} else {
 							<%=rejectConnName%>.errorMessage = new java.util.ArrayList<String>();
 							for(int i=0;i<response_<%=cid%>.getStatus().getStatusDetail().length;i++) {
 								<%=rejectConnName%>.errorMessage.add(response_<%=cid%>.getStatus().getStatusDetail(i).getMessage());
 							}
 						}
    				
<%
    				}
    			}
    		}
    	}//2
	}//1
%>