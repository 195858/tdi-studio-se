<%@ jet 
	package="org.talend.designer.codegen.translators" 
	imports="
		org.talend.core.model.process.INode
		org.talend.core.model.temp.ECodePart		
		org.talend.core.model.process.IConnection 
		org.talend.core.model.metadata.IMetadataTable 
		org.talend.core.model.process.EConnectionType 
        org.talend.core.model.process.ElementParameterParser
		org.talend.designer.codegen.config.CodeGeneratorArgument
		org.talend.core.model.process.IConnectionCategory
  		java.util.List
 		 java.util.Set
  		java.util.HashSet
		java.util.Iterator
	"
	class="IterateSubProcessFooter" 
%>
<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
	INode node = (INode)codeGenArgument.getArgument();
	ECodePart codePart = codeGenArgument.getCodePart();
	//boolean trace = codeGenArgument.isTrace();
	boolean stat = codeGenArgument.isStatistics();
	
	boolean isRunInMultiThread = codeGenArgument.getIsRunInMultiThread();	
	
	Set<IConnection> connSet =  new HashSet<IConnection>();
	connSet.addAll(node.getOutgoingConnections(EConnectionType.FLOW_MAIN));
	connSet.addAll(node.getOutgoingConnections(EConnectionType.FLOW_MERGE));
	//String incomingName = codeGenArgument.getIncomingName();
	
	Set<IConnection> iterateConnSet =  new HashSet<IConnection>();
	iterateConnSet.addAll(node.getIncomingConnections(EConnectionType.ITERATE));
	
	String iterateNodeName = node.getUniqueName();
	
	List<IConnection> allSubProcessConnection = codeGenArgument.getAllMainSubTreeConnections();
%>

<%
	if (codePart.equals(ECodePart.END)) {//1
		boolean parallelIterate = false;
		for (IConnection iterateConn : iterateConnSet) {//2
			parallelIterate = "true".equals(ElementParameterParser.getValue(iterateConn, "__ENABLE_PARALLEL__")); 
	        if (parallelIterate) {//3
	        	String rowList=","; 
				for (IConnection conn : allSubProcessConnection) {
					rowList += conn.getUniqueName()+",";
				}
				rowList = rowList.substring(0, rowList.length()-1);
				if(stat){
%>
				runStat.updateStatOnConnection("<%=iterateConn.getUniqueName() %>",2,"exec"+globalMap.get("PARALLEL_ITERATOR_THREAD_ID"));
<%
				}
%>
			} catch (Exception e) {			
					((java.util.Map) threadLocal.get()).put("status", "failure");
					e.printStackTrace();
			}
			this.isRunning = false;			

			Integer localErrorCode = (Integer) (((java.util.Map) threadLocal.get()).get("errorCode"));
			String localStatus = (String) (((java.util.Map) threadLocal.get()).get("status"));
			if (localErrorCode != null) {
				if (this.errorCode == null || localErrorCode.compareTo(this.errorCode) > 0) {
					this.errorCode = localErrorCode;
				}
			} else if (!this.status.equals("failure")) {
				this.status = localStatus;
			}			
		}
	}

	<%=node.getUniqueName() %>Thread bt_<%=node.getUniqueName() %> = new <%=node.getUniqueName() %>Thread(globalMap<%=rowList %>,threadIdCounter++);
	mtp_<%=node.getUniqueName() %>.execute(bt_<%=node.getUniqueName() %>);
	
<%if(!isRunInMultiThread){%>
	if (bt_<%=node.getUniqueName() %>.errorCode != null) {
		if (errorCode == null || bt_<%=node.getUniqueName() %>.errorCode.compareTo(errorCode) > 0) {
			errorCode = bt_<%=node.getUniqueName() %>.errorCode;
		}
	} else if (!status.equals("failure")) {
		status = bt_<%=node.getUniqueName() %>.status;
	}	
<%}else{%>
	Integer localErrorCode = (Integer) (((java.util.Map) threadLocal.get()).get("errorCode"));
	String localStatus = (String) (((java.util.Map) threadLocal.get()).get("status"));
	
	if (bt_<%=node.getUniqueName() %>.errorCode != null) {
		if (localErrorCode == null || bt_<%=node.getUniqueName() %>.errorCode.compareTo(localErrorCode) > 0) {
			((java.util.Map) threadLocal.get()).put("errorCode", bt_<%=node.getUniqueName() %>.errorCode);
		}
	} else if (!localStatus.equals("failure")) {
		((java.util.Map) threadLocal.get()).put("status", bt_<%=node.getUniqueName() %>.status);
	}
<%}%>
	
<%
				continue;
			}else {//3
	      		if(stat){
%>
				runStat.updateStatOnConnection("<%=iterateConn.getUniqueName() %>", 2, "exec" + NB_ITERATE_<%=iterateNodeName %>);
<%
		  		}
		  	}//3				
		}//2
	}//1
%>