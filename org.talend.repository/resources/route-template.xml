<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0">

	<!-- Talend Route OSGi blueprint descriptor -->
#if ($hasCXFSamlConsumer || $hasCXFSamlProvider
	||$hasCXFRegistryProvider || $hasCXFRegistryConsumer)
#[[
	<cm:cm-properties persistent-id="org.talend.esb.job" id="org.talend.esb.job"
		xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.2.0" />
]]#
#end
#if ($hasCXFSamlProvider || $hasCXFRegistryProvider)
#[[
	<cm:cm-properties persistent-id="org.talend.esb.job.service" id="org.talend.esb.job.service"
		xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.2.0" />
]]#
#end
#if ($hasCXFSamlProviderAuthz)
#[[
	<cm:property-placeholder persistent-id="org.talend.esb.authorization.pep" placeholder-prefix="$pep{"
		xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.2.0" />
]]#
#end
#if ($hasCXFSamlConsumer || $hasCXFRegistryConsumer)
#[[
	<cm:cm-properties persistent-id="org.talend.esb.job.client" id="org.talend.esb.job.client"
		xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.2.0" />
	<cm:cm-properties persistent-id="org.talend.esb.job.client.sts" id="org.talend.esb.job.client.sts"
		xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.2.0" />
]]#
#end

	<bean id="route" class="${className}">
		<property name="bundleContext" ref="blueprintBundleContext" />
		<!-- ESB Features For CXF -->
#if ($useSAM)
		<property name="eventFeature">
			<reference interface="org.talend.esb.sam.agent.feature.EventFeature" />
		</property>
#end
#if ($hasCXFSamlConsumer || $hasCXFSamlProvider
||$hasCXFRegistryProvider || $hasCXFRegistryConsumer)
#[[
		<property name="policies" ref="org.talend.esb.job" />
]]#
#end
#if ($hasCXFSamlProvider || $hasCXFRegistryProvider)
#[[
		<property name="securityProps" ref="org.talend.esb.job.service" />
]]#
#end
#if ($hasCXFSamlConsumer || $hasCXFRegistryConsumer)
#[[
		<property name="clientProperties" ref="org.talend.esb.job.client" />
		<property name="stsProperties" ref="org.talend.esb.job.client.sts" />
]]#
#end
#if ($hasCXFSamlProviderAuthz)
#[[
		<property name="authorizationInterceptor">
			<bean class="org.talend.esb.authorization.xacml.rt.pep.CXFXACMLAuthorizingInterceptor">
				<property name="pdpAddress" value="$pep{tesb.pdp.address}"/>
			</bean>
		</property>
]]#
#end

#if (!$dataSources.isEmpty())
		<property name="dataSources">
			<map>
#foreach ($alias in $dataSources)
				<entry key="${alias}">
					<reference interface="javax.sql.DataSource" filter="(osgi.jndi.service.name=${alias})" />
				</entry>
#end ## end data sources aliases loop
			</map>
		</property>
#end
	</bean>

	<service ref="route">
		<interfaces>
			<value>routines.system.api.TalendJob</value>
			<value>routines.system.api.TalendESBRoute</value>
		</interfaces>
		<service-properties>
			<entry key="name" value="${name}" />
			<entry key="type" value="route" />
		</service-properties>
	</service>

</blueprint>
