<%@ jet 
imports="
		org.talend.core.model.process.INode 
		org.talend.core.model.process.ElementParameterParser 
		org.talend.designer.codegen.config.CodeGeneratorArgument
" 
%>

<%
CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
INode node = (INode)codeGenArgument.getArgument();
String cid = node.getUniqueName();

String dbServer = ElementParameterParser.getValue(node, "__SERVER__");
String dbhost = ElementParameterParser.getValue(node, "__HOST__");
String dbport = ElementParameterParser.getValue(node, "__PORT__");
String dbname= ElementParameterParser.getValue(node, "__DBNAME__");
String dbuser= ElementParameterParser.getValue(node, "__USER__");
String commitEvery = ElementParameterParser.getValue(node, "__COMMIT_EVERY__");
String tableName = ElementParameterParser.getValue(node,"__TABLE__");
String identityInsert = ElementParameterParser.getValue(node, "__IDENTITY_INSERT__");
String dbschema = ElementParameterParser.getValue(node, "__DB_SCHEMA__");
boolean useExistingConn = ("true").equals(ElementParameterParser.getValue(node,"__USE_EXISTING_CONNECTION__"));
String dbproperties = ElementParameterParser.getValue(node, "__PROPERTIES__");
String dbquery= ElementParameterParser.getValue(node, "__QUERY__");
	
    	dbquery = org.talend.core.model.utils.NodeUtil.replaceCRLFInMEMO_SQL(dbquery);
    
boolean usePrepareStatement = "true".equals(ElementParameterParser.getValue(node,"__USE_PREPAREDSTATEMENT__"));
if(useExistingConn) {
	String connection = ElementParameterParser.getValue(node,"__CONNECTION__");
	String conn = "conn_" + connection;
	%>
	java.sql.Connection conn_<%=cid %> = (java.sql.Connection)globalMap.get("<%=conn %>");
	<%
} else {
    %>
    java.lang.Class.forName("com.sybase.jdbc3.jdbc.SybDriver");
    
<%
	if(dbproperties == null || ("\"\"").equals(dbproperties) || ("").equals(dbproperties)) {
%>
		String url_<%=cid %> = "jdbc:sybase:Tds:" + <%=dbServer%> + ":" + <%=dbport%> + "/" + <%=dbname%>; 
<%
	} else {
%>
		String url_<%=cid %> = "jdbc:sybase:Tds:" + <%=dbServer%> + ":" + <%=dbport%> + "/" + <%=dbname%> + "?" + <%=dbproperties%>;
<%
	}
%>
    String dbUser_<%=cid %> = <%=dbuser%>;
    <%
    String passwordFieldName = "__PASS__";
    %>

    <%@ include file="@{org.talend.designer.components.localprovider}/components/templates/password.javajet"%>

    String dbPwd_<%=cid %> = decryptedPassword_<%=cid%>;

    java.sql.Connection conn_<%=cid%> = java.sql.DriverManager.getConnection(url_<%=cid %>,dbUser_<%=cid%>,dbPwd_<%=cid%>);
    <%
}
%>
String tableName_<%=cid%> = <%=tableName%> ;
String dbschema_<%=cid%> = <%=dbschema%>;
<%
if(!useExistingConn) {
    if(!("").equals(commitEvery) && !("0").equals(commitEvery)){
        %>
        conn_<%=cid%>.setAutoCommit(false);        
        int commitEvery_<%=cid%> = <%=commitEvery %>;    
        int commitCounter_<%=cid%> = 0;    
        <%
    }
}
%>

if (dbschema_<%=cid%> != null && dbschema_<%=cid%>.trim().length() != 0) {
	tableName_<%=cid%> = dbschema_<%=cid%> + "." + <%=tableName%>;
}

<%
	if (usePrepareStatement ) {
%>
	java.sql.PreparedStatement pstmt_<%=cid %> = conn_<%=cid%>.prepareStatement(<%=dbquery%>);	
<%
	} else {
%>
	java.sql.Statement stmt_<%=cid %> = conn_<%=cid %>.createStatement();
<%
	}
%>
<%
if(("true").equals(identityInsert)){
    %>
    stmt_<%=cid %>.execute("SET IDENTITY_INSERT "+ tableName_<%=cid%> +" ON");
    <%
}
%>
String query_<%=cid %> = "";
boolean whetherReject_<%=cid%> = false;
