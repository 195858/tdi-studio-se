<%@ jet
imports="
        java.util.ArrayList
        java.util.LinkedList
        java.util.List
        java.util.Map
        org.talend.core.model.metadata.IMetadataColumn
        org.talend.core.model.metadata.IMetadataTable
        org.talend.core.model.metadata.types.JavaType
        org.talend.core.model.metadata.types.JavaTypesManager
        org.talend.core.model.process.EConnectionType
        org.talend.core.model.process.ElementParameterParser
        org.talend.core.model.process.IConnection
        org.talend.core.model.process.IConnectionCategory
        org.talend.core.model.process.INode
        org.talend.designer.codegen.config.CodeGeneratorArgument
"
%>
<%
	if (incomingName == null && incomingConns.size() > 0) {
		   incomingName = incomingConns.get(0).getName(); 
	}
	
	IMetadataTable preMetadataTable = null;
	for (IConnection incomingConn : incomingConns) {
		if ( incomingConn.getLineStyle().equals(EConnectionType.FLOW_MERGE) && incomingConn.getName().equals(incomingName)) {
			preMetadataTable = incomingConn.getMetadataTable();
		    break;
		}
	}
	
	if(preMetadataTable==null){
		return "";
	}
	
	if (incomingConns != null) {
		for (IConnection conn : incomingConns) {
			if (conn.getLineStyle().hasConnectionCategory(IConnectionCategory.DATA) && conn.getName().equals(incomingName)){

				IMetadataTable metadata = conn.getMetadataTable();
				if(metadata!=null) {
					List<IMetadataColumn> columns = metadata.getListColumns();
					List<HL7Node> xmlNodes = getTree(rootTable, columns, incomingName);
					if(xmlNodes != null && xmlNodes.size() > 0) {
%>
	org.talend.hl7.Segment seg_<%=cid %> = new org.talend.hl7.Segment("<%=xmlNodes.get(0).hl7Type%>");
	msg_<%=cid %>.addSegment(seg_<%=cid %>);
<%
						for (int i = 0 ; i< xmlNodes.size(); i++) {
							IMetadataColumn column = xmlNodes.get(i).relatedColumn;
							if (column != null) {
								JavaType javaType = JavaTypesManager.getJavaTypeFromId(column.getTalendType());
								boolean isPrimitive = JavaTypesManager.isJavaPrimitiveType( javaType, column.isNullable());
				    			if(!isPrimitive) {
%>
	if(<%=incomingName %>.<%=column.getLabel() %> != null) {
<% 
    						} 
%>
	tmpValue_<%=cid %> =
 <%
		    			        String pattern = column.getPattern() == null || column.getPattern().trim().length() == 0 ? null : column.getPattern();
		    			        if (javaType == JavaTypesManager.DATE && pattern != null && pattern.trim().length() != 0) {
    			            %>
    						FormatterUtils.format_Date(<%=incomingName %>.<%=column.getLabel() %>, <%=pattern %>);
    						<%	
								} else if(javaType == JavaTypesManager.BIGDECIMAL){
    						%>
    						<%=column.getPrecision() == null? incomingName + "." + column.getLabel() : incomingName + "." + column.getLabel() + ".setScale(" + column.getPrecision() + ", java.math.RoundingMode.HALF_UP)" %>.toPlainString();
							<%
								} else if(javaType == JavaTypesManager.BYTE_ARRAY){
    						%>
    						java.nio.charset.Charset.forName(<%=encoding %>).decode(java.nio.ByteBuffer.wrap(<%=incomingName %>.<%=column.getLabel() %>)).toString();
    						<%
    			        		} else {
    			            %>
    						String.valueOf(<%=incomingName %>.<%=column.getLabel() %>);
    						<%				
	    			        	}
								if(!isPrimitive) {
%>   				
	}
<%
								}
							} else { // use the default value
%>
tmpValue_<%=cid %> = <%=(xmlNodes.get(i).defaultValue==null || "".equals(xmlNodes.get(i).defaultValue)? "\"\"":xmlNodes.get(i).defaultValue) %>;
<%
							}
%>
	seg_<%=cid %>.addField(org.talend.hl7.TalendHL7Util.setValue("<%=xmlNodes.get(i).path %>",tmpValue_<%=cid %>));
<%
						} // for (int i = 0 ; i< xmlNodes.size(); i++);
					}
				} //if(metadata!=null)
				break; // each input connector generate one segment
			}
		} // for (IConnection conn : incomingConns)
	}
%>
