<%@ jet
imports="
    org.talend.core.model.process.IConnection
    org.talend.core.model.process.EConnectionType
    org.talend.core.model.process.INode
    org.talend.core.model.process.ElementParameterParser
    org.talend.core.model.metadata.IMetadataTable 
    org.talend.core.model.metadata.IMetadataColumn 
    org.talend.designer.codegen.config.CodeGeneratorArgument
    java.util.List
    java.util.Map
    java.util.ArrayList
    org.talend.commons.utils.StringUtils
"
%>

<%
CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;

INode node = (INode)codeGenArgument.getArgument();
String cid = node.getUniqueName();

List<Map<String, String>> columnOptions =
    (List<Map<String,String>>)ElementParameterParser.getObjectValue(
        node,
        "__COLUMN_OPTIONS__"
    );


List<IMetadataTable> metadatas = node.getMetadataList();
if (metadatas != null && metadatas.size() > 0) {
    List<IConnection> inputConnections;
    List<IConnection> outputConnections;
    String main = null;
    inputConnections = (List<IConnection>) node.getIncomingConnections();
    outputConnections = (List<IConnection>) node.getOutgoingConnections();
    for (IConnection connection : inputConnections) {
        if (connection == null) {
            continue;
        }

        if (connection.getLineStyle() == EConnectionType.FLOW_MAIN) {
            main = connection.getName();
            continue;
        }
    }

    IMetadataTable metadata = metadatas.get(0);

    int column_num = 0;
    for (Map<String, String> columnOption: columnOptions) {
        if (columnOption.get("REPLACE").equals("true")) {
            String columnName = metadata.getListColumns().get(column_num).getLabel();
%>
String inputFlow<%=columnName%> = <%=main%>.<%=columnName%>;
for(Object o:replace_<%=cid%>.keySet()){
    String search<%=cid%> = (String)o;
    String replace<%=cid%> = replace_<%=cid%>.get(o);
    inputFlow<%=columnName%> = inputFlow<%=columnName%>.replaceAll(search<%=cid%>,replace<%=cid%>);
}
<%
        }
        column_num++;
    }
    
    //output
    int outColumn_num=0;
    for (IConnection connection : outputConnections){
        String outConName = connection.getName();
        for(Map<String,String> columnOption: columnOptions){
          if (columnOption.get("REPLACE").equals("true")){
              String columnname = connection.getTarget().getMetadataList().get(0).getListColumns().get(outColumn_num).getLabel();
%>
        <%=main%>.<%=columnname%> = inputFlow<%=columnname%>;

<%
          }
          outColumn_num ++;
       }
       
    }
    
    
%>

<%
}
%>
