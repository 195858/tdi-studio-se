<%@ jet
	imports="
		org.talend.core.model.process.INode
		org.talend.core.model.process.ElementParameterParser
		org.talend.designer.codegen.config.CodeGeneratorArgument
	"
%>
<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
	INode node = (INode) codeGenArgument.getArgument();
	String cid = node.getUniqueName();
	String kListen = ElementParameterParser.getValue(node, "__KEEPLISTENING__");
%>
		} catch (Throwable e) {
			messagesExchange_<%=cid%>.serveOutputFault(new Exception("talend job execution error", e));
		} finally {
			messagesExchange_<%=cid%>.release();
            // clear for next cycle
            boolean keepListening_<%=cid%> = "true".equals("<%=kListen%>");
            // Exit from this loop is made by the configuring "Keep listening"
            // parameter to false. Then we will have a break before.
            if (!keepListening_<%=cid%>) {
                System.out.println("--- [tESBProviderRequest] 'keep listening' is FALSE - job will be stopped");
                break;
            }
		}
		// This is the end of the ESB Service Provider loop
	}
} finally {
	// for "keep listening" == false web service need a time to serve response
	Thread.currentThread();
	Thread.sleep(500);
	// unsubscribe
	handlerThread_<%=cid%>.stopEndpoint();
}

