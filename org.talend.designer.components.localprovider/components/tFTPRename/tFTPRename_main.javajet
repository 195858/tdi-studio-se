<%@ jet 
	imports="
		org.talend.core.model.process.INode 
		org.talend.core.model.metadata.IMetadataTable 
		org.talend.core.model.process.ElementParameterParser
		org.talend.designer.codegen.config.CodeGeneratorArgument
		java.util.List
        java.util.Map
	"
%>
<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
	INode node = (INode)codeGenArgument.getArgument();
	String overwrite=ElementParameterParser.getValue(node, "__OVERWRITE__");
	String cid = node.getUniqueName();
	boolean sftp = ElementParameterParser.getValue(node, "__SFTP__").equals("true");
	String remotedir = ElementParameterParser.getValue(node, "__REMOTEDIR__");
	
	if(sftp){//sftp support
%>	

	  	
		globalMap.put("<%=cid %>_CURRENT_STATUS", "No file renamed.");
    	java.util.Set<String> keySet<%=cid %> = map<%=cid %>.keySet();   
    	for (String key<%=cid %> : keySet<%=cid %>)
   		{    
   			try{
   			c<%=cid%>.rename(<%=remotedir %>+"/"+key<%=cid %>, <%=remotedir %>+"/"+map<%=cid %>.get(key<%=cid %>));
   			globalMap.put("<%=cid %>_CURRENT_STATUS", "File rename OK.");
   			}catch(com.jcraft.jsch.SftpException se){
   			globalMap.put("<%=cid %>_CURRENT_STATUS", "File rename fail.");
   			throw se;
   			}
   			nb_file_<%=cid%>++;
   		}
	


<%}else{%>//normal ftp
	 	
    	java.util.Set<String> keySet<%=cid %> = map<%=cid %>.keySet(); 
    	try{  
    	for (String key<%=cid %> : keySet<%=cid %>)
   		{
     		<%if(overwrite.equals("always")){%>
     			String fromFile_<%=cid%> = key<%=cid %>;
     			String toFile_<%=cid%> = map<%=cid %>.get(key<%=cid %>);
     		    if(ftp<%=cid%>.exists(fromFile_<%=cid%>)){
     		    	if(ftp<%=cid%>.exists(toFile_<%=cid%> + ".tmp")){
     		    		ftp<%=cid%>.delete(toFile_<%=cid%> + ".tmp");
     		    	}
     		    	if(ftp<%=cid%>.exists(toFile_<%=cid%>)){
		     			ftp<%=cid %>.rename(toFile_<%=cid%>, toFile_<%=cid%> + ".tmp");
     		    	}
	     			ftp<%=cid %>.rename(fromFile_<%=cid%>, toFile_<%=cid%>);
	     			if(ftp<%=cid%>.exists(toFile_<%=cid%> + ".tmp")){
		     			ftp<%=cid%>.delete(toFile_<%=cid%> + ".tmp");
	     			}
	     			globalMap.put("<%=cid %>_CURRENT_STATUS", "File rename OK.");
	     			nb_file_<%=cid%>++;
     			}
     		<%}%>
     		<%if(overwrite.equals("never")){%>
     			if(!(ftp<%=cid%>.exists(map<%=cid %>.get(key<%=cid %>))))
     			{
     			ftp<%=cid %>.rename(key<%=cid %>, map<%=cid %>.get(key<%=cid %>));
     			globalMap.put("<%=cid %>_CURRENT_STATUS", "File rename OK.");
     			nb_file_<%=cid%>++;
     			}
     		<%}%>
     		<%if(overwrite.equals("size_differ")){%>
     			if((ftp<%=cid%>.exists(map<%=cid %>.get(key<%=cid %>)))){
					com.enterprisedt.net.ftp.FTPFile ftpnewNamefile<%=cid%>=ftp<%=cid%>.fileDetails(map<%=cid %>.get(key<%=cid %>));
					com.enterprisedt.net.ftp.FTPFile ftporigNamefile<%=cid%>=ftp<%=cid%>.fileDetails(key<%=cid %>);
					long newNameSize<%=cid%>=ftpnewNamefile<%=cid%>.size();
					long origNameSize<%=cid%>=ftporigNamefile<%=cid%>.size();
					if(!(newNameSize<%=cid%>==origNameSize<%=cid%>))
					{
		     			String fromFile_<%=cid%> = key<%=cid %>;
		     			String toFile_<%=cid%> = map<%=cid %>.get(key<%=cid %>);
						if(ftp<%=cid%>.exists(fromFile_<%=cid%>)){
		     		    	if(ftp<%=cid%>.exists(toFile_<%=cid%> + ".tmp")){
		     		    		ftp<%=cid%>.delete(toFile_<%=cid%> + ".tmp");
		     		    	}
		     		    	if(ftp<%=cid%>.exists(toFile_<%=cid%>)){
				     			ftp<%=cid %>.rename(toFile_<%=cid%>, toFile_<%=cid%> + ".tmp");
		     		    	}
			     			ftp<%=cid %>.rename(fromFile_<%=cid%>, toFile_<%=cid%>);
			     			if(ftp<%=cid%>.exists(toFile_<%=cid%> + ".tmp")){
				     			ftp<%=cid%>.delete(toFile_<%=cid%> + ".tmp");
			     			}
			     			globalMap.put("<%=cid %>_CURRENT_STATUS", "File rename OK.");
			     			nb_file_<%=cid%>++;
		     			}
					}
				}else{
					ftp<%=cid %>.rename(key<%=cid %>, map<%=cid %>.get(key<%=cid %>));
					globalMap.put("<%=cid %>_CURRENT_STATUS", "File rename OK.");
					nb_file_<%=cid%>++;
				}
     		<%}%>
   		}
   		}catch(com.enterprisedt.net.ftp.FTPException e){
   			globalMap.put("<%=cid %>_CURRENT_STATUS", "File rename fail.");
            throw e;
   		}
	

<%}%>
