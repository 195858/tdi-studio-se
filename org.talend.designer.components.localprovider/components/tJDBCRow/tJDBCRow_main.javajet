<%@ jet 
imports="
    org.talend.core.model.process.INode
    org.talend.core.model.process.ElementParameterParser
    org.talend.core.model.metadata.IMetadataTable
    org.talend.core.model.metadata.IMetadataColumn
    org.talend.designer.codegen.config.CodeGeneratorArgument
    org.talend.core.model.process.IConnection
    org.talend.core.model.metadata.types.JavaTypesManager
    org.talend.core.model.metadata.types.JavaType
    org.talend.core.model.process.IConnectionCategory
    java.util.List
"
%>

<%
CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
INode node = (INode) codeGenArgument.getArgument();
String cid =  node.getUniqueName();

String dieOnError = ElementParameterParser.getValue(node, "__DIE_ON_ERROR__");
String commitEvery = ElementParameterParser.getValue(node, "__COMMIT_EVERY__");

String incomingConnName = null;

List<IMetadataColumn> columnList = null;

String rejectConnName = null;
List<? extends IConnection> rejectConns = node.getOutgoingConnections("REJECT");
if(rejectConns != null && rejectConns.size() > 0) {
    IConnection rejectConn = rejectConns.get(0);
    rejectConnName = rejectConn.getName();
}
List<IMetadataColumn> rejectColumnList = null;
IMetadataTable metadataTable = node.getMetadataFromConnector("REJECT");
if(metadataTable != null) {
    rejectColumnList = metadataTable.getListColumns();      
}

List<? extends IConnection> outgoingConns = node.getOutgoingSortedConnections();

for(IConnection conn : outgoingConns) {
    if (conn.getLineStyle().hasConnectionCategory(IConnectionCategory.DATA)) {%>
    
    <%=conn.getName() %> = null;            
<%      }
}
String dbquery= ElementParameterParser.getValue(node, "__QUERY__");
	       dbquery = dbquery.replaceAll("\n"," ");
    	   dbquery = dbquery.replaceAll("\r"," ");
%>

statement_<%=cid%> = connection_<%=cid%>.prepareStatement(<%=dbquery%>);

whetherReject_<%=cid%> = false;
<%
if (!commitEvery.equals("") && !commitEvery.equals("0")) {
    %>
    commitCounter_<%=cid%>++;
    <%
}

int parametersCount = 0;
int index = dbquery.indexOf("?");
while (index >= 0) {
    parametersCount++;
    index = dbquery.indexOf("?", index + 1);
}

List<IMetadataTable> metadatas = node.getMetadataList();
if ((metadatas != null) && (metadatas.size() > 0)) {
    IMetadataTable metadata = metadatas.get(0);
    if (metadata != null) {
        List<? extends IConnection> inConnections = node.getIncomingConnections();
        columnList = metadata.getListColumns();
        
        if (inConnections != null && inConnections.size() > 0){
            IConnection inConnection = inConnections.get(0);
            incomingConnName = inConnection.getName();
            int parameterIndex = 1;
            
            for (IMetadataColumn column : columnList) {
                String typeToGenerate = JavaTypesManager.getTypeToGenerate(column.getTalendType(), column.isNullable());
                
                String method;
                if (typeToGenerate.equals("byte[]")) {
                    method = "Bytes";
                } else if (typeToGenerate.equals("Char") || typeToGenerate.equals("Character")) {
                    method = "String";
                } else if (typeToGenerate.equals("java.util.Date")) {
                    method = "Date";
                } else if (typeToGenerate.equals("Integer")) {
                    method = "Int";
                } else {
                    method = typeToGenerate.substring(0, 1).toUpperCase() + typeToGenerate.substring(1);
                }
                
                // Bind parameter to SQL statement
                if (parameterIndex <= parametersCount) {
                    if (typeToGenerate.equals("Char") || typeToGenerate.equals("Character")) {
                        %>
                        statement_<%=cid%>.setString(<%=parameterIndex%>, String.valueOf(<%=inConnection.getName()%>.<%=column.getLabel()%>));
                        <%
                    } else if (typeToGenerate.equals("java.util.Date")) {
                        %>
                        if (<%=inConnection.getName()%>.<%=column.getLabel()%> != null) {
                            statement_<%=cid%>.setDate(<%=parameterIndex%>, new java.sql.Date(<%=inConnection.getName()%>.<%=column.getLabel()%>.getTime()));
                        } else {
                            statement_<%=cid%>.setDate(<%=parameterIndex%>, null);
                        }
                        <%
                    } else {
                        %>
                        statement_<%=cid%>.set<%=method%>(<%=parameterIndex%>, <%=inConnection.getName()%>.<%=column.getLabel()%>);
                        <%
                    }
                }
                
                parameterIndex++;
            }
        }
    }
}

%>
try {
    statement_<%=cid%>.execute();
} catch (Exception e) {
    whetherReject_<%=cid%> = true;
    <%
    if (dieOnError.equals("true")) {
        %>
        throw(e);
        <%
    } else {
        if(rejectConnName != null && rejectColumnList != null && rejectColumnList.size() > 0) {
            %>
            <%=rejectConnName %> = new <%=rejectConnName %>Struct();
        <%
            for(IMetadataColumn column : columnList) {
                %>
                <%=rejectConnName%>.<%=column.getLabel()%> = <%=incomingConnName%>.<%=column.getLabel()%>;
                <%
            }
            %>
            <%=rejectConnName%>.errorMessage = e.getMessage();
            <%
        } else {
            %>
            System.err.print(e.getMessage());
            <%
        }
    } 
    %>
}

<%

if(outgoingConns != null && outgoingConns.size() > 0) {
    %>
    if(!whetherReject_<%=cid%>) {
    <%
        for(IConnection outgoingConn : outgoingConns) {
            if(rejectConnName == null || (rejectConnName != null && !outgoingConn.getName().equals(rejectConnName))) {
                if(outgoingConn.getLineStyle().hasConnectionCategory(IConnectionCategory.DATA)) {
                    
                    %>
                                   <%=outgoingConn.getName()%> = new <%=outgoingConn.getName()%>Struct();
                    <%
                    for(IMetadataColumn column : columnList) {
                        %>
                        <%=outgoingConn.getName()%>.<%=column.getLabel()%> = <%=incomingConnName%>.<%=column.getLabel()%>;
                        <%                  
                    }
                }
            }
        }
    %>
    }
    <%
}

if (!commitEvery.equals("") && !commitEvery.equals("0")) {
    %>
    if (commitEvery_<%=cid%> <= commitCounter_<%=cid%>) {
        connection_<%=cid%>.commit();
        commitCounter_<%=cid%> = 0;
    }
    <%
}
%>