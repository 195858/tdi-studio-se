<%@ jet 
imports="
    org.talend.core.model.process.INode 
    org.talend.core.model.process.ElementParameterParser
    org.talend.designer.codegen.config.CodeGeneratorArgument
    org.talend.designer.runprocess.ProcessorUtilities
    org.talend.designer.runprocess.ProcessorException
    java.util.Map
    java.util.List
"
%>

<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
	INode node = (INode)codeGenArgument.getArgument();
	String cid = node.getUniqueName();
	
//	String interpreterPath = "<interpreter_path>";
//    if (codeGenArgument.getInterpreterPath() != null) {
//        interpreterPath = codeGenArgument.getInterpreterPath();
//        interpreterPath = interpreterPath.replace("\\","/");
//    }

//    String libPath = "<library_path>";
//    if (codeGenArgument.getLibPath() != null) {
//        libPath = codeGenArgument.getLibPath();
//        libPath = libPath.replace("\\","/");
//    }

//    String runtimeFilePath = "<runtime_path>";
//    if (codeGenArgument.getRuntimeFilePath() != null) {
//        runtimeFilePath = codeGenArgument.getRuntimeFilePath();
//        runtimeFilePath = runtimeFilePath.replace("\\","/");
//    }

//    String currentProjectName = "<project_name>";
//    if (codeGenArgument.getCurrentProjectName() != null) {
//        currentProjectName = codeGenArgument.getCurrentProjectName();
//    }
    
    List<Map<String, String>> contextParams = (List<Map<String,String>>)ElementParameterParser.getObjectValue(node, "__CONTEXTPARAMS__");
    String process = ElementParameterParser.getValue(node,"__PROCESS_TYPE_PROCESS__");
    String context = ElementParameterParser.getValue(node,"__PROCESS_TYPE_CONTEXT__");
    process = process.replace("'", "");
    context = context.replace("'", "");
    String[] codeOptions = new String[] {"--father_pid=\"+pid+\"", "--root_pid=\"+rootPid+\""};
    String[] commandLineWindows = new String[] {"<command>"};
    String[] commandLineUnix = new String[] {"<command>"};
    String[] commandLine = new String[] {"<command>"};
    try {
        // for windows
       	commandLineWindows = ProcessorUtilities.getCommandLine("win32", true, process, context,org.talend.designer.runprocess.IProcessor.NO_STATISTICS,org.talend.designer.runprocess.IProcessor.NO_TRACES, codeOptions);
        // for linux
       	commandLineUnix = ProcessorUtilities.getCommandLine("linux", true, process, context,org.talend.designer.runprocess.IProcessor.NO_STATISTICS,org.talend.designer.runprocess.IProcessor.NO_TRACES, codeOptions);
        // for current OS
       	commandLine = ProcessorUtilities.getCommandLine(true, process, context,org.talend.designer.runprocess.IProcessor.NO_STATISTICS,org.talend.designer.runprocess.IProcessor.NO_TRACES, codeOptions);
    } catch (ProcessorException e) {
    }
    
    
StringBuffer contextStr = new StringBuffer();
for (int i=0; i<contextParams.size(); i++) {
    Map<String, String> contextParam = contextParams.get(i);
    String name = contextParam.get("PARAM_NAME_COLUMN");
    String value = contextParam.get("PARAM_VALUE_COLUMN");    
    contextStr.append(",\"--context_param ");
    contextStr.append(name);

    if(value.contains("context.getProperty")) {
        contextStr.append("=\"+");
        contextStr.append(value);
    }else{
    	contextStr.append("=\"+\"");
        contextStr.append(value.replaceAll("\"","\\\\\\\\\\\\\""));        
        contextStr.append("\"");
    } 
  }


%>

Runtime runtime_<%=cid %> = Runtime.getRuntime();
final Process ps_<%=cid %>;
<%
// if the generation is to export, then there will be a test for the current OS.
if (ProcessorUtilities.isExportConfig()) { 
%>
if (System.getProperty("os.name").startsWith("Windows")) {
   ps_<%=cid %> = runtime_<%=cid %>.exec(new String[] {
   <%
   for (int i=0; i<commandLineWindows.length; i++) {
   %>
   "<%=commandLineWindows[i] %>"<%if (i <= (commandLineWindows.length -2)) {%>,<%}%>
   <%
   }
   %>
   <%=contextStr.toString() %>
   });
   
} else {
   ps_<%=cid %> = runtime_<%=cid %>.exec(new String[] {
   <%
   for (int i=0; i<commandLineUnix.length; i++) {
   %>
   "<%=commandLineUnix[i] %>"<%if (i <= (commandLineUnix.length -2)) {%>,<%}%>
   <%
   }
   %>
   <%=contextStr.toString() %>
   });
   
}
<%
} else {
%>
   ps_<%=cid %> = runtime_<%=cid %>.exec(new String[] {
   <%
   for (int i=0; i<commandLine.length; i++) {
   %>
   "<%=commandLine[i] %>"<%if (i <= (commandLine.length -2)) {%>,<%}%>
   <%
   }
   %>   
   <%=contextStr.toString() %>
   });   
   	
<%
}
%>


Thread normal_<%=cid %> = new Thread() {
	public void run() {
		try {
			java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(ps_<%=cid %>.getInputStream()));
			String line = "";
			try {
				while((line = reader.readLine()) != null) {

					System.out.println(line);

				}
			} finally {
				reader.close();
			}
		} catch(java.io.IOException ioe) {
			ioe.printStackTrace();
		}
	}
};
normal_<%=cid %>.start();

Thread error_<%=cid %> = new Thread() {
	public void run() {
		try {
			java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(ps_<%=cid %>.getErrorStream()));
			String line = "";
			try {
				while((line = reader.readLine()) != null) {
					System.err.println(line);
				}
			} finally {
				reader.close();
			}
		} catch(java.io.IOException ioe) {
			ioe.printStackTrace();
		}
	}
};
error_<%=cid %>.start();

ps_<%=cid %>.waitFor();
normal_<%=cid %>.interrupt();
error_<%=cid %>.interrupt();