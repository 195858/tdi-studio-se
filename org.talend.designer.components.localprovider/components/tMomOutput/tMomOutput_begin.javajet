<%@ jet 
imports="
    org.talend.core.model.process.INode 
    org.talend.core.model.process.ElementParameterParser 
    org.talend.core.model.metadata.IMetadataTable 
    org.talend.core.model.metadata.IMetadataColumn 
    org.talend.core.model.process.IConnection
    org.talend.designer.codegen.config.CodeGeneratorArgument
    org.talend.core.model.process.IConnectionCategory
    java.util.List
    java.util.Map
    org.talend.core.model.utils.TalendTextUtils
" 
class="MomInput"
%>

<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
	INode node = (INode)codeGenArgument.getArgument();
	String cid = node.getUniqueName();

        boolean isUseSharedConnection = ("true").equals(ElementParameterParser.getValue(node, "__USE_CONNECTION__"));
        String connectionComponentName = ElementParameterParser.getValue(node, "__CONNECTION__");

	String serverType=ElementParameterParser.getValue(node, "__SERVER__");
	String host=ElementParameterParser.getValue(node, "__SERVERADDRESS__");
	String port=ElementParameterParser.getValue(node, "__SERVERPORT__");
	String msgType = ElementParameterParser.getValue(node, "__MSGTYPE__");
	String to = ElementParameterParser.getValue(node, "__TO__");
	String deliverMode = ElementParameterParser.getValue(node, "__DELIVERY_MODE__");
	
	boolean transacted = "true".equals(ElementParameterParser.getValue(node, "__IS_TRANSACTED__"));
	String acknowledgmentMode = ElementParameterParser.getValue(node, "__ACKNOWLEDGMENT_MODE__");
	
	boolean failover =  ("true").equals(ElementParameterParser.getValue(node, "__FAILOVER__"));
	List<Map<String,String>> servers = (List<Map<String,String>>)ElementParameterParser.getObjectValue(node, "__SERVERS__");

	String dbuser= ElementParameterParser.getValue(node, "__USER__");
	String dbpwd= ElementParameterParser.getValue(node, "__PASS__");
		
	IMetadataTable metadata=null;
	List<IMetadataTable> metadatas = node.getMetadataList();
		if ((metadatas!=null)&&(metadatas.size()>0)) {
			metadata = metadatas.get(0);
		}
%>
	java.util.Hashtable props_<%=cid%>=new java.util.Hashtable();

<%      if (isUseSharedConnection) { %>
	        javax.jms.Connection connection_<%=cid %> = (javax.jms.Connection) globalMap.get("connection_<%=connectionComponentName%>");
                connection_<%=cid %>.start();
	
		javax.jms.Session session_<%=cid %> = connection_<%=cid %>.createSession(<%=transacted%>, javax.jms.Session.<%=acknowledgmentMode%>);
		
		javax.jms.Destination des_<%=cid %>;
<%
		if (("Queue").equals(msgType)) {
%>
			des_<%=cid %> = session_<%=cid %>.createQueue(<%=to %>);
<%
		} else {
%>
	    	des_<%=cid %> = session_<%=cid %>.createTopic(<%=to %>);
<%
		}
%>
 
		    javax.jms.MessageProducer producer_<%=cid %> = session_<%=cid %>.createProducer(des_<%=cid %>);
		
<%
		if ("N_PERSISTENT".equals(deliverMode)) {
%>
			producer_<%=cid %>.setDeliveryMode(javax.jms.DeliveryMode.NON_PERSISTENT);
<%
		} else if ("PERSISTENT".equals(deliverMode)) {
%>
			producer_<%=cid %>.setDeliveryMode(javax.jms.DeliveryMode.PERSISTENT);
<%
		}
%>
		    
<%      } else if (("JBoss").equals(serverType) || ("ActiveMQ").equals(serverType)) {// server judgement
	
	/*---------------------------------------1.initial jms connection factry---------------------------------*/ 
		if(("JBoss").equals(serverType)){ 
%>
			props_<%=cid%>.put(javax.naming.Context.INITIAL_CONTEXT_FACTORY,"org.jnp.interfaces.NamingContextFactory");
			props_<%=cid%>.put(javax.naming.Context.PROVIDER_URL, <%=host%>+":"+<%=port%>);
			props_<%=cid%>.put("java.naming.rmi.security.manager", "yes");
			
			javax.naming.Context context_<%=cid%>=new javax.naming.InitialContext(props_<%=cid%>);
			javax.jms.ConnectionFactory factory_<%=cid%>
				= (javax.jms.ConnectionFactory)context_<%=cid%>.lookup("ConnectionFactory");	
				
<%
		}else if(("ActiveMQ").equals(serverType) || isUseSharedConnection) {
%>
			// BS
			String url_<%=cid %> ="";
      <%if(failover){
				StringBuilder sbServers=new StringBuilder();
				int i=0;
				for(Map<String, String> serversMap : servers) {
					String strHost = TalendTextUtils.removeQuotes(serversMap.get("SERVERS_HOST"));
					String strPort = TalendTextUtils.removeQuotes(serversMap.get("SERVERS_PORT"));
					if(i>0)sbServers.append(",");
					sbServers.append("tcp://");
					sbServers.append(strHost);
					sbServers.append(":");
					sbServers.append(strPort);
					i++;
				}
				%>
				// BS
				url_<%=cid %> = "failover:(<%=sbServers.toString()%>)?randomize=false";
			<%}else{%>
				url_<%=cid %> = "tcp://"+<%=host%>+":"+<%=port%>;
			<%}%>			
			
			System.out.println("Connecting to URL: " + url_<%=cid %>);
			System.out.println("Producing " + (<%=!("Queue").equals(msgType)%> ? "topic" : "queue") + ": " + <%=to %>);
			
			
			org.apache.activemq.ActiveMQConnectionFactory factory_<%=cid %> = 
				new org.apache.activemq.ActiveMQConnectionFactory(url_<%=cid %>);
<%
		}
		
		/*---------------------------------------2.create Queue Or Topic from connection ---------------------------------*/ 
%>	
				
<%               if(dbuser == null || ("\"\"").equals(dbuser) || ("").equals(dbuser)) { %>
			javax.jms.Connection connection_<%=cid %> = factory_<%=cid %>.createConnection();
<%		} else { %>
			javax.jms.Connection connection_<%=cid %> = factory_<%=cid %>.createConnection(<%=dbuser%>,<%=dbpwd%>);
<%		} %>
			
		connection_<%=cid %>.start();
	
		javax.jms.Session session_<%=cid %> = connection_<%=cid %>.createSession(<%=transacted%>, javax.jms.Session.<%=acknowledgmentMode%>);
		
		javax.jms.Destination des_<%=cid %>;
<%
		if (("Queue").equals(msgType)) {
%>
			des_<%=cid %> = session_<%=cid %>.createQueue(<%=to %>);
<%
		} else {
%>
	    	des_<%=cid %> = session_<%=cid %>.createTopic(<%=to %>);
<%
		}
%>
		javax.jms.MessageProducer producer_<%=cid %> = session_<%=cid %>.createProducer(des_<%=cid %>);
		
<%
		if ("N_PERSISTENT".equals(deliverMode)) {
%>
			producer_<%=cid %>.setDeliveryMode(javax.jms.DeliveryMode.NON_PERSISTENT);
<%
		} else if ("PERSISTENT".equals(deliverMode)) {
%>
			producer_<%=cid %>.setDeliveryMode(javax.jms.DeliveryMode.PERSISTENT);
<%
		}
%>
		

<%
	}else{ //server judgement   /***WebSphere MQ*****/
		String channel=ElementParameterParser.getValue(node, "__CHANNEL__");
		String qm=ElementParameterParser.getValue(node, "__QM__");
		String queue = ElementParameterParser.getValue(node, "__QUEUE__");
		boolean needSSLCipher = ("true").equals(ElementParameterParser.getValue(node,"__SET_MQ_SSL_CIPHER__"));
		String sslCipher = ElementParameterParser.getValue(node, "__MQ_SSL_CIPHER__");
%>
	    props_<%=cid%>.put("hostname", <%=host%>);
	    props_<%=cid%>.put("port", Integer.valueOf(<%=port%>));
	    props_<%=cid%>.put("channel", <%=channel%>);
	    props_<%=cid%>.put("CCSID", new Integer(1208));
	    props_<%=cid%>.put("transport", "MQSeries");
	    
	    <%
		if(needSSLCipher){
		%>
			com.ibm.mq.MQEnvironment.sslCipherSuite = "<%=sslCipher%>";
		<%
		}
		if(!(dbuser == null) && !("\"\"").equals(dbuser) && !("").equals(dbuser)) {
		%>
			props_<%=cid%>.put("userID",<%=dbuser%>);
			props_<%=cid%>.put("password",<%=dbpwd%>);
		<%
		}
		%>
	
		com.ibm.mq.MQQueueManager qMgr_<%=cid%> = new com.ibm.mq.MQQueueManager(<%=qm%>, props_<%=cid%>);
	    com.ibm.mq.MQQueue remoteQ_<%=cid%> = qMgr_<%=cid%>.accessQueue(<%=queue%>, 16);
	    com.ibm.mq.MQPutMessageOptions opM_<%=cid%> = new com.ibm.mq.MQPutMessageOptions();
<%	    
	    if (transacted) {
%>	
		opM_<%=cid%>.options=opM_<%=cid%>.options+com.ibm.mq.MQC.MQGMO_SYNCPOINT;
<%
	    }
	}
%>
	
