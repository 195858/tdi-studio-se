<%@ jet 
imports="
    org.talend.core.model.process.INode 
    org.talend.core.model.metadata.IMetadataTable
    org.talend.core.model.metadata.IMetadataColumn
    org.talend.core.model.process.IConnection    
    org.talend.core.model.process.IConnectionCategory
    org.talend.core.model.process.ElementParameterParser
    org.talend.designer.codegen.config.CodeGeneratorArgument
    java.util.List
    java.util.Map
    org.talend.core.model.metadata.types.JavaTypesManager
	org.talend.core.model.metadata.types.JavaType
"
%>

<%
CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
INode node = (INode)codeGenArgument.getArgument();
String origin = ElementParameterParser.getValue(node, "__ORIGIN__");
String cid = origin;

String SUM = "sum";
String COUNT = "count";
String MAX = "max";
String MIN = "min";
String FIRST = "first";
String LAST = "last";
String AVG = "avg";
String COUNT_DISTINCT = "distinct";
String LIST = "list";
String LIST_OBJECT = "list_object";
String STD_DEV = "std_dev";

List<IMetadataTable> mestadataTableListOut = node.getMetadataList();

if (mestadataTableListOut!=null && mestadataTableListOut.size()>0) { // T_InMain_AggR_600
    IMetadataTable metadataTableOutput = mestadataTableListOut.get(0);
    if (metadataTableOutput!=null) { // T_InMain_AggR_601
        List<Map<String, String>> operations = (List<Map<String,String>>)ElementParameterParser.getObjectValue(node, "__OPERATIONS__");
        List<Map<String, String>> groupbys = (List<Map<String,String>>)ElementParameterParser.getObjectValue(node, "__GROUPBYS__");
		int sizeOperations = operations.size();
		int sizeGroupbys = groupbys.size();
		
        String[] groupby_type = new String[sizeGroupbys];
        for(int i = 0; i < sizeGroupbys; i++){ // T_InMain_AggR_602
        	String columnname = groupbys.get(i).get("INPUT_COLUMN");
        	List<? extends IConnection> incomingConnections = node.getIncomingConnections();
            if (incomingConnections != null && !incomingConnections.isEmpty()) {
            	for (IConnection conn : incomingConnections) {
        			if (conn.getLineStyle().hasConnectionCategory(IConnectionCategory.DATA)) {
                		IMetadataTable inMetadata = conn.getMetadataTable();
               			for (IMetadataColumn column: inMetadata.getListColumns()) {
                    		if(column.getLabel().equals(columnname)){
        						JavaType javaType = JavaTypesManager.getJavaTypeFromId(column.getTalendType());
        						if(javaType == JavaTypesManager.BOOLEAN){
        							groupby_type[i] = "Boolean";
        						}else if(javaType == JavaTypesManager.BYTE){
        							groupby_type[i] = "Byte";
        						}else if(javaType == JavaTypesManager.BYTE_ARRAY){
        							groupby_type[i] = "byte[]";
        						}else if(javaType == JavaTypesManager.CHARACTER){
        							groupby_type[i] = "Character";
        						}else if(javaType == JavaTypesManager.DATE){
        							groupby_type[i] = "java.util.Date";
        						}else if(javaType == JavaTypesManager.DOUBLE){
        							groupby_type[i] = "Double";
        						}else if(javaType == JavaTypesManager.FLOAT){
        							groupby_type[i] = "Float";
        						}else if(javaType == JavaTypesManager.INTEGER){
        							groupby_type[i] = "Integer";
        						}else if(javaType == JavaTypesManager.LONG){
        							groupby_type[i] = "Long";
        						}else if(javaType == JavaTypesManager.SHORT){
        							groupby_type[i] = "Short";
        						}else if(javaType == JavaTypesManager.STRING){
        							groupby_type[i] = "String";
        						}else if(javaType == JavaTypesManager.OBJECT){
        							groupby_type[i] = "Object";
        						}
        						break;
                    		}
        				}
        			}
        		}
          	}
        } // T_InMain_AggR_602
		
		%>
        nb_line_<%=cid %> = 0;
        <%


		IConnection outputConn = null;
		List< ? extends IConnection> outConns = node.getOutgoingSortedConnections();
		if (outConns!=null) {
			if (outConns.size()>0) {
				IConnection conn = outConns.get(0);
				if (conn.getLineStyle().hasConnectionCategory(IConnectionCategory.DATA)) {
					outputConn = conn;    					
				}
			}
		}


		List<IMetadataColumn> outputColumns = metadataTableOutput.getListColumns();
		int sizeColumns = outputColumns.size();
		if(sizeOperations > 0 || sizeGroupbys > 0){ // T_InMain_AggR_603

    			next_column:
    			for(int c = 0; c < sizeColumns; c++){ // T_InMain_AggR_604
    				IMetadataColumn outputColumn = outputColumns.get(c);
    				String outputColumnName = outputColumn.getLabel();
    				String outputTypeToGenerate = JavaTypesManager.getTypeToGenerate(outputColumn.getTalendType(), outputColumn.isNullable());
    				String primitiveOutputType = JavaTypesManager.getTypeToGenerate(outputColumn.getTalendType(), false);
    				JavaType outputJavaType = JavaTypesManager.getJavaTypeFromId(outputColumn.getTalendType());
    				String patternValue = outputColumn.getPattern() == null || outputColumn.getPattern().trim().length() == 0 ? null : outputColumn.getPattern();
    				
    				for(int g = 0; g < sizeGroupbys; g++){ // T_InMain_AggR_605
    					Map<String, String> groupby = groupbys.get(g);
    					String inputColumn = groupby.get("INPUT_COLUMN");
    					String outputGroupColumn = groupby.get("OUTPUT_COLUMN");
    					if(outputGroupColumn.equals(outputColumnName)){ // T_InMain_AggR_606
    						Boolean sameType = false;
                			
    						List<? extends IConnection> incomingConnections = node.getIncomingConnections();
            				if (incomingConnections != null && !incomingConnections.isEmpty()) {
            					loop:
            					for (IConnection conn : incomingConnections) {
            						IMetadataTable inMetadata = conn.getMetadataTable();
            						for (IMetadataColumn inColumn: inMetadata.getListColumns()) {
            							if(inColumn.getLabel().equals(inputColumn)){
            								JavaType inputJavaType = JavaTypesManager.getJavaTypeFromId(inColumn.getTalendType());
            								sameType = (inputJavaType == outputJavaType);
            								break loop;
            							}
            						}
                				}
            				}
            				if(sameType){
            				    %>
            				    <%= outputConn.getName() %>.<%=outputGroupColumn %> = aggregated_row_<%=cid %>.<%=inputColumn %>;
            				    <%  					
            				}else{
            				    %>
            				    String s_<%=inputColumn %>_<%=outputGroupColumn %>_<%=cid %> = String.valueOf(aggregated_row_<%=cid %>.<%=inputColumn %>);
            				    <%= outputConn.getName() %>.<%=outputGroupColumn %> = <%
    							if(outputJavaType == JavaTypesManager.STRING || outputJavaType == JavaTypesManager.OBJECT) {
    								%>s_<%=inputColumn %>_<%=outputGroupColumn %>_<%=cid %><%
    							}else if(outputJavaType == JavaTypesManager.BYTE_ARRAY){
    								%>s_<%=inputColumn %>_<%=outputGroupColumn %>_<%=cid %>.getBytes()<%
    							} else if(outputJavaType == JavaTypesManager.DATE) {
    								%>s_<%=inputColumn %>_<%=outputGroupColumn %>_<%=cid %>.equals("null") ? null : ParserUtils.parseTo_Date(s_<%=inputColumn %>_<%=outputGroupColumn %>_<%=cid %>, <%= patternValue %>)<%
    							} else {
    								%>ParserUtils.parseTo_<%= outputTypeToGenerate %>(s_<%=inputColumn %>_<%=outputGroupColumn %>_<%=cid %>)<%
    							}
            				    %>;
            				    <%
    						}
    						continue next_column;
    					} // T_InMain_AggR_606
    				} // T_InMain_AggR_605
				
    				for(int o = 0; o < sizeOperations; o++){ // T_InMain_AggR_615
    					Map<String, String> operation = operations.get(o);
                		String function = operation.get("FUNCTION");
                		String outOperation = operation.get("OUTPUT_COLUMN");
                		String inOperation = operation.get("INPUT_COLUMN");
						boolean ignoreNull = operation.get("IGNORE_NULL").equals("true");

						JavaType inputJavaType = null;

                		if(outOperation.equals(outputColumnName)){ // T_InMain_AggR_616

							boolean outputIsNumber = JavaTypesManager.isNumberType(outputJavaType, false);
							boolean outputIsObject = outputJavaType == JavaTypesManager.OBJECT;
							boolean outputIsList = outputJavaType == JavaTypesManager.LIST;
							boolean outputIsString = outputJavaType == JavaTypesManager.STRING;
							boolean outputIsDate = outputJavaType == JavaTypesManager.DATE;
			
							boolean isValidTypeForOperation = 
								(function.equals(SUM) || function.equals(AVG) || function.equals(COUNT) || function.equals(COUNT_DISTINCT) || function.equals(STD_DEV)) && outputIsNumber  
								|| (function.equals(COUNT) || function.equals(COUNT_DISTINCT)) && !outputIsNumber && (outputIsObject || outputIsString)
								|| (function.equals(MIN) || function.equals(MAX)) && (outputIsNumber || outputIsObject || outputIsString || outputIsDate)
								|| 
									!function.equals(SUM) 
									&& !function.equals(AVG) 
									&& !function.equals(COUNT) 
									&& !function.equals(COUNT_DISTINCT) 
									&& !function.equals(MIN) 
									&& !function.equals(MAX)
									&& !function.equals(LIST)
									&& !function.equals(LIST_OBJECT)									 
									&& !outputIsNumber
								|| function.equals(FIRST)
								|| function.equals(LAST)
								|| function.equals(LIST_OBJECT) && (outputIsObject || outputIsList)
								|| function.equals(LIST) && outputIsString
							;
	
							if(!isValidTypeForOperation) {
								continue;
							}
            				
                			if(function.equals(AVG)){ // T_InMain_AggR_617
                			
                				int pre = 10;
                       		 	Integer precision = outputColumn.getPrecision();
                           		 if(precision!=null && precision!=0) { 
                           		 	pre = precision;
                           		 }               				

                			    %>
                                if(operation_result_<%=cid %>.<%=inOperation %>_count > 0){
                                	<%
									if(outputJavaType == JavaTypesManager.BIGDECIMAL) {
									%>
	    								<%= outputConn.getName() %>.<%=outOperation %> = operation_result_<%=cid %>.<%=inOperation %>_sum.divide(new BigDecimal(operation_result_<%=cid %>.<%=inOperation %>_count));
    								<%
									} else {
									%>
	    								double <%= outputConn.getName() %>_<%=outOperation %>_temp = (double) operation_result_<%=cid %>.<%=inOperation %>_sum / (double) operation_result_<%=cid %>.<%=inOperation %>_count;
	    								
	    								<% 
	    								if(outputIsString) {
	    								
		    								%><%= outputConn.getName() %>.<%=outOperation %> = String.valueOf(<%= outputConn.getName() %>_<%=outOperation %>_temp);
											<%
											
										} else {
		    							
		    								%><%= outputConn.getName() %>.<%=outOperation %> = (<%=primitiveOutputType%>) <%= outputConn.getName() %>_<%=outOperation %>_temp;
											<%
										
										}
										%>
    								<%
    								}
    								%>
                                }
                                <%
                			}  // T_InMain_AggR_617
                			else if(function.equals(COUNT)) { // T_InMain_AggR_638
                			
								if(outputJavaType == JavaTypesManager.BIGDECIMAL) {
								%>
    								<%= outputConn.getName() %>.<%=outOperation %> = new BigDecimal(aggregated_row_<%=cid %>.count);
								<%
								} else {
            			
									if(outputIsString) {
									
	    								%><%= outputConn.getName() %>.<%=outOperation %> = String.valueOf(aggregated_row_<%=cid %>.count);
										<%
										
									} else {
	    							
	                                	%><%= outputConn.getName() %>.<%=outOperation %> = (<%=primitiveOutputType%>) aggregated_row_<%=cid %>.count;
	                                	<%
									
									}
								}

							} // T_InMain_AggR__638
                			else if(function.equals(COUNT_DISTINCT)) { // T_InMain_AggR_658
                			
								if(outputJavaType == JavaTypesManager.BIGDECIMAL) {
								%>
    								<%= outputConn.getName() %>.<%=outOperation %> = new BigDecimal(operation_result_<%=cid %>.distinctValues.size());
								<%
								} else {
            			
									if(outputIsString) {
									
	    								%><%= outputConn.getName() %>.<%=outOperation %> = String.valueOf(operation_result_<%=cid %>.distinctValues.size());
										<%
										
									} else {
	    							
	                                	%><%= outputConn.getName() %>.<%=outOperation %> = (<%=primitiveOutputType%>) operation_result_<%=cid %>.distinctValues.size();
	                                	<%
									
									}
								}

							} // T_InMain_AggR__638
                			else if(function.equals(SUM)) { // T_InMain_AggR_618

								if(outputIsString) {
								
    								%><%= outputConn.getName() %>.<%=outOperation %> = String.valueOf(aggregated_row_<%=cid %>.<%=outOperation %>_<%=function %>);
									<%
									
								} else {
    							
                                	%><%= outputConn.getName() %>.<%=outOperation %> = aggregated_row_<%=cid %>.<%=outOperation %>_<%=function %>;
                                	<%
								
								}
									
    						} // T_InMain_AggR_618 
    						else if(function.equals(LIST)) { // T_InMain_AggR_679
    							%>
    								<%= outputConn.getName() %>.<%=outOperation %> = operation_result_<%=cid %>.<%=inOperation %>_<%=function %>.toString();
	    						<% 
    						}  // T_InMain_AggR_679
    						else if(function.equals("list_object")) { // T_InMain_AggR_619
    							%>
    								<%= outputConn.getName() %>.<%=outOperation %> = operation_result_<%=cid %>.<%=inOperation %>_<%=function %>;
    							<% 
    						}  // T_InMain_AggR_619
    						else if(function.equals("std_dev")) { // T_InMain_AggR_620
    						
    						
    							if(outputIsNumber || outputIsObject){ // T_InMain_AggR_621

									if(outputJavaType == JavaTypesManager.BIGDECIMAL) {
										
		    							%>double result_<%=inOperation %>_<%=function %>_<%=cid %> = utilClass_<%=cid %>.sd(operation_result_<%=cid %>.<%=inOperation %>_<%=function %>.toArray(new Double[0]));
		    							//if(((Double)result_<%=inOperation %>_<%=function %>_<%=cid %>).equals((Double)Double.NaN)) {
										//	<%= outputConn.getName() %>.<%=outOperation %> = null;
		    							//} else {
											<%= outputConn.getName() %>.<%=outOperation %> = new BigDecimal(result_<%=inOperation %>_<%=function %>_<%=cid %>);
		    							//}
										
										<%
										
									} else {
	            			
	    								%><%= outputConn.getName() %>.<%=outOperation %> = (<%=primitiveOutputType%>) utilClass_<%=cid %>.sd(operation_result_<%=cid %>.<%=inOperation %>_<%=function %>.toArray(new Double[0]));
	    								<%
    								 		
									}

    							} // T_InMain_AggR_621
    							
    							else if(outputIsString){ // T_InMain_AggR_622
								
									%><%= outputConn.getName() %>.<%=outOperation %> = String.valueOf(utilClass_<%=cid %>.sd(operation_result_<%=cid %>.<%=inOperation %>_<%=function %>.toArray(new Double[0])));
									<%
									
    							} // T_InMain_AggR_622
    							
    						} // T_InMain_AggR_620
    						
    						else { // T_InMain_AggR_636
    							
								%>
                                <%= outputConn.getName() %>.<%=outOperation %> = operation_result_<%=cid %>.<%=inOperation %>_<%=function %>;
                                <%
                                
    							
    						} // T_InMain_AggR_636

                			continue next_column;
                			
                		} // T_InMain_AggR_616

                		
                } // T_InMain_AggR_615
    		
    		} // T_InMain_AggR_604
			%>
            //in the deepest end
            nb_line_<%=cid %>++;
            
            <%

		} // T_InMain_AggR_603

		%>
        //globalMap.put("<%=origin %>",result_list_<%=cid %>);
        globalMap.put("<%=cid %>_NB_LINE",nb_line_<%=cid %>);
        <%
	} // T_InMain_AggR_601
} // T_InMain_AggR_600
%>