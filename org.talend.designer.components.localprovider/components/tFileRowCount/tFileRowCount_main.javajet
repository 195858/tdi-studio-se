<%@ jet 
imports="
    org.talend.core.model.process.INode 
    org.talend.core.model.process.ElementParameterParser
    org.talend.designer.codegen.config.CodeGeneratorArgument
"
%>

<%
CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
INode node = (INode)codeGenArgument.getArgument();
String cid = node.getUniqueName();

String filename = ElementParameterParser.getValue(
    node,
    "__FILENAME__"
);

String rowSeparator = ElementParameterParser.getValue(
    node,
    "__ROWSEPARATOR__"
);
%>

        java.io.BufferedReader br_<%=cid %> = new java.io.BufferedReader
        									(new java.io.InputStreamReader
        									(new java.io.FileInputStream(<%=filename %>)));
        int lineCount_<%=cid %> = 0;

        String rowSeparator_<%=cid %> = <%=rowSeparator %>;
        byte[] bytes_<%=cid %> = rowSeparator_<%=cid %>.getBytes();
        int index_<%=cid %> = 0;
        
		int oneChar_<%=cid%> = 0;
		int emptyLineCount_<%=cid%> = 0;
		int rowSeparator_count_<%=cid%> = 0;
		boolean ready_eof_<%=cid%> = false;
		boolean bFirstRowIsEmpty_<%=cid%> = true;
		
		if (bytes_<%=cid%>.length > 0) {
			while ((oneChar_<%=cid%> = br_<%=cid%>.read()) != -1) {

				if (oneChar_<%=cid%> == bytes_<%=cid%>[index_<%=cid%>]) {

					if (index_<%=cid%> == bytes_<%=cid%>.length - 1) {
						lineCount_<%=cid%> ++;
						
						if (bFirstRowIsEmpty_<%=cid%>){
						  emptyLineCount_<%=cid%> ++;
						  bFirstRowIsEmpty_<%=cid%> = false; // only one time
						}
						
						if ( ++ rowSeparator_count_<%=cid%> == 2){
							emptyLineCount_<%=cid%> ++;
							rowSeparator_count_<%=cid%> = 1;
						}
						
						index_<%=cid%> = 0;
						ready_eof_<%=cid%> = false;
					} else {
						index_<%=cid%> ++;
						continue;
					}
				} else {
				    if (bFirstRowIsEmpty_<%=cid%>)
				      bFirstRowIsEmpty_<%=cid%> = false;
				    
					index_<%=cid%> = 0;
					rowSeparator_count_<%=cid%> = 0;
					ready_eof_<%=cid%> = true;
				}
			}
			// add last line not end with row separator
			if (ready_eof_<%=cid%>)
				lineCount_<%=cid%> ++;
		}

        globalMap.put("<%=cid %>_COUNT",lineCount_<%=cid %>); 
        br_<%=cid %>.close();