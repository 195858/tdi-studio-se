<%@ jet 
imports="
    	org.talend.core.model.process.INode 
    	org.talend.core.model.process.ElementParameterParser 
		org.talend.core.model.metadata.IMetadataTable 
		org.talend.core.model.metadata.IMetadataColumn
		org.talend.designer.codegen.config.CodeGeneratorArgument
		org.talend.core.model.process.IConnection
		org.talend.core.model.process.IConnectionCategory
		org.talend.core.model.metadata.types.JavaTypesManager
		org.talend.core.model.metadata.types.JavaType
        java.util.Map
        java.util.List
" 
%>

<%
CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
INode node = (INode)codeGenArgument.getArgument();
String cid = node.getUniqueName();

String url = ElementParameterParser.getValue(node,"__URL__");
String method = ElementParameterParser.getValue(node,"__METHOD__");
List<Map<String, String>> headers = (List<Map<String,String>>)ElementParameterParser.getObjectValue(node,"__HEADERS__");
        
String body = ElementParameterParser.getValue(node,"__BODY__");
body = body.replaceAll("[\r\n]", " ");
%>

		com.sun.jersey.api.client.Client restClient_<%=cid%> = com.sun.jersey.api.client.Client.create();
		com.sun.jersey.api.client.WebResource restResource_<%=cid%>;
		if(<%=url%>!=null && !<%=url%>.equals("")){
			restResource_<%=cid%> = restClient_<%=cid%>.resource(<%=url%>);
		}else{
			throw new IllegalArgumentException("url can't be empty!");
		}
		
		com.sun.jersey.api.client.ClientResponse errorResponse_<%=cid%> = null;
		String restResponse_<%=cid%> = "";
	try{
		restResponse_<%=cid%> = restResource_<%=cid%>
		
<%
        for (int i = 0; i < headers.size(); i++) {
            Map<String, String> line = headers.get(i);
%>
        .header(<%= line.get("NAME") %>,<%= line.get("VALUE") %>)
<%
        }
%>  
<%
		if("GET".equals(method)){
%>
		.get(String.class);
<%
		}else if("POST".equals(method)){
%>
		.post(String.class,<%=body%>);
<%		
		}else if("PUT".equals(method)){
%>
		.put(String.class,<%=body%>);
<%
		}else if("DELETE".equals(method)){
%>
		.delete(String.class);
<%
		}	
%>
	}catch (com.sun.jersey.api.client.UniformInterfaceException ue) {
        errorResponse_<%=cid%> = ue.getResponse();
    }
		// for output
<%
	List< ? extends IConnection> conns = node.getOutgoingSortedConnections();
	if (conns!=null) {//1
		if (conns.size()>0) {//2
			IConnection conn = conns.get(0); //the first connection
			if (conn.getLineStyle().hasConnectionCategory(IConnectionCategory.DATA)) {//3
%>		
				<%=conn.getName() %> = new <%=conn.getName() %>Struct();
				if(errorResponse_<%=cid%>!=null){
					<%=conn.getName() %>.ERROR_CODE = errorResponse_<%=cid%>.getStatus();
				}else{
					<%=conn.getName() %>.Body = restResponse_<%=cid%>;
				}
<%			
			}//3
		}//2
	}//1
%>